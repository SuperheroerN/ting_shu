<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="æœ‰å£°ä¹¦æœç´¢å’Œæ’­æ”¾å¹³å°">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æœ‰å£°ä¹¦">
    <title>ä¹¦ç±è¯¦æƒ… - æœ‰å£°ä¹¦æœç´¢</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/detail.css">
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/announcement.css">
    <link rel="stylesheet" href="/static/css/global-player.css">
</head>
<body>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth-guard.js"></script>
    <script src="/static/js/announcement.js"></script>
    <script src="/static/js/pwa-install.js"></script>
    <div class="container">
        <header>
            <a href="/" class="home-link">é¦–é¡µ</a>
            <a id="back-to-results" href="#" class="back-link">ç»“æœ</a>
        </header>
        
        <script>
            // è·å–æœç´¢ç»“æœé¡µURLçš„å‡½æ•°
            function getSearchResultsUrl() {
                // å°è¯•ä»URLå‚æ•°è·å–æœç´¢å…³é”®è¯
                const urlParams = new URLSearchParams(window.location.search);
                const keyword = urlParams.get('keyword');
                
                if (keyword) {
                    return `/results?keyword=${encodeURIComponent(keyword)}`;
                }
                
                // å°è¯•ä»localStorageè·å–æœç´¢å…³é”®è¯
                const savedKeyword = localStorage.getItem('lastSearchKeyword');
                if (savedKeyword) {
                    return `/results?keyword=${encodeURIComponent(savedKeyword)}`;
                }
                
                // é»˜è®¤è¿”å›é¦–é¡µ
                return '/';
            }
            
            // è®¾ç½®è¿”å›æœç´¢ç»“æœé¡µçš„é“¾æ¥
            document.addEventListener('DOMContentLoaded', function() {
                const backToResultsLink = document.getElementById('back-to-results');
                if (backToResultsLink) {
                    backToResultsLink.href = getSearchResultsUrl();
                }
            });
        </script>
        
        <div class="detail-content">
            <div class="book-detail-section">
                <div class="book-cover">
                    <img src="{{ book_image if book_image else 'https://via.placeholder.com/200x300?text=ä¹¦ç±å°é¢' }}" alt="{{ book_title }}" onerror="this.src='https://via.placeholder.com/200x300?text=å°é¢ç¼ºå¤±'">
                </div>
                <div class="book-meta">
                    <h2 class="book-title-detail">{{ book_title }}</h2>
                    {% if book_anchor %}
                    <p class="book-anchor-detail"><span class="label">ä¸»æ’­:</span> {{ book_anchor }}</p>
                    {% endif %}
                    <div class="book-actions-meta">
                        <div class="interface-badge-detail {{ interface }}">{{ interface }}æ¥å£</div>
                        <button id="add-to-bookshelf-btn" class="bookshelf-btn" 
                                data-book-id="{{ book_id }}" 
                                data-interface="{{ interface }}"
                                data-book-title="{{ book_title }}"
                                data-book-image="{{ book_image }}"
                                data-book-anchor="{{ book_anchor }}"
                                title="åŠ å…¥ä¹¦æ¶">
                            <span class="bookshelf-icon">ğŸ“š</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="chapter-list-section">
                <h2 class="chapter-list-title">ç« èŠ‚åˆ—è¡¨</h2>
                <p class="chapter-list-info">å…± <strong>{{ pagination.total_count }}</strong> ç« ï¼Œå½“å‰ç¬¬ <strong>{{ pagination.current_page }}</strong>/<strong>{{ pagination.total_pages }}</strong> é¡µ</p>
                <div class="chapters">
                    {% if chapters %}
                        <ul class="chapter-items">
                            {% for chapter in chapters %}
                                <li class="chapter-item" data-book-id="{{ book_id }}" data-chapter-id="{{ chapter.chapter_id }}">
                                    <a href="/player/{{ book_id }}/{{ interface }}/{{ chapter.chapter_id }}" class="chapter-link">
                                        <div class="chapter-info">
                                            <span class="chapter-order">{{ ((pagination.current_page - 1) * pagination.page_size) + loop.index }}.</span>
                                            <span class="chapter-title">{{ chapter.title }}</span>
                                            <span class="chapter-id">{{ chapter.chapter_id }}</span>
                                        </div>
                                        <div class="chapter-duration">{{ chapter.duration }}</div>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>æš‚æ— ç« èŠ‚ä¿¡æ¯</p>
                    {% endif %}
                </div>
                
                <!-- åˆ†é¡µæ§ä»¶ -->
                {% if pagination.total_pages > 1 %}
                    <div class="pagination">
                        <div class="pagination-info">
                            <span>ç¬¬ {{ pagination.current_page }}/{{ pagination.total_pages }} é¡µ</span>
                            <span>å…± {{ pagination.total_count }} ç« </span>
                        </div>
                        <div class="pagination-controls">
                            <!-- ä¸Šä¸€é¡µæŒ‰é’® -->
                            <a href="?page={{ pagination.current_page - 1 }}" 
                               class="page-btn prev-btn {% if pagination.current_page == 1 %}disabled{% endif %}" 
                               {% if pagination.current_page == 1 %}onclick="return false;"{% endif %}>
                                ä¸Šä¸€é¡µ
                            </a>
                            
                            <!-- é¡µç å¯¼èˆª -->
                            <div class="page-numbers">
                                {% set start_page = pagination.current_page - 2 %}
                                {% if start_page < 1 %}
                                    {% set start_page = 1 %}
                                {% endif %}
                                {% set end_page = pagination.current_page + 2 %}
                                {% if end_page > pagination.total_pages %}
                                    {% set end_page = pagination.total_pages %}
                                {% endif %}
                                
                                <!-- é¦–é¡µ -->
                                {% if start_page > 1 %}
                                    <a href="?page=1" class="page-number">1</a>
                                    {% if start_page > 2 %}
                                        <span class="ellipsis">...</span>
                                    {% endif %}
                                {% endif %}
                                
                                <!-- ä¸­é—´é¡µç  -->
                                {% for p in range(start_page, end_page + 1) %}
                                    <a href="?page={{ p }}" 
                                       class="page-number {% if p == pagination.current_page %}active{% endif %}">
                                        {{ p }}
                                    </a>
                                {% endfor %}
                                
                                <!-- æœ«é¡µ -->
                                {% if end_page < pagination.total_pages %}
                                    {% if end_page < pagination.total_pages - 1 %}
                                        <span class="ellipsis">...</span>
                                    {% endif %}
                                    <a href="?page={{ pagination.total_pages }}" class="page-number">
                                        {{ pagination.total_pages }}
                                    </a>
                                {% endif %}
                            </div>
                            
                            <!-- ä¸‹ä¸€é¡µæŒ‰é’® -->
                            <a href="?page={{ pagination.current_page + 1 }}" 
                               class="page-btn next-btn {% if pagination.current_page == pagination.total_pages %}disabled{% endif %}" 
                               {% if pagination.current_page == pagination.total_pages %}onclick="return false;"{% endif %}>
                                ä¸‹ä¸€é¡µ
                            </a>
                        </div>
                        
                        <!-- è‡ªå®šä¹‰è·³è½¬ -->
                        <div class="custom-page">
                            <span>è·³è½¬åˆ°</span>
                            <input type="number" id="page-input" min="1" max="{{ pagination.total_pages }}" 
                                   value="{{ pagination.current_page }}">
                            <span>é¡µ</span>
                            <button id="go-btn">è·³è½¬</button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <script>
        // Toast æç¤ºæ¶ˆæ¯å‡½æ•°
        function showToast(message, type = 'success') {
            // ç§»é™¤å·²å­˜åœ¨çš„ toast
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            // åˆ›å»º toast å…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `toast-message toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? 'âœ“' : 'âœ•'}</div>
                <div class="toast-text">${message}</div>
            `;
            
            document.body.appendChild(toast);
            
            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }
        
        // ä¹¦æ¶åŠŸèƒ½
        // åˆå§‹åŒ–åŠ å…¥ä¹¦æ¶æŒ‰é’®ï¼ˆä½¿ç”¨APIï¼‰
        document.addEventListener('DOMContentLoaded', async function() {
            const addBtn = document.getElementById('add-to-bookshelf-btn');
            if (addBtn) {
                const bookId = addBtn.dataset.bookId;
                const interface = addBtn.dataset.interface;
                
                // æ£€æŸ¥æ˜¯å¦å·²åœ¨ä¹¦æ¶ä¸­
                try {
                    const inBookshelf = await BookshelfAPI.check(bookId, interface);
                    if (inBookshelf) {
                        addBtn.classList.add('in-bookshelf');
                        addBtn.title = 'å·²åœ¨ä¹¦æ¶ä¸­';
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ä¹¦æ¶çŠ¶æ€å¤±è´¥:', error);
                }
                
                // ç‚¹å‡»äº‹ä»¶
                addBtn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    
                    const bookData = {
                        book_id: this.dataset.bookId,
                        interface: this.dataset.interface,
                        book_title: this.dataset.bookTitle,
                        book_image: this.dataset.bookImage,
                        book_anchor: this.dataset.bookAnchor
                    };
                    
                    try {
                        const inBookshelf = await BookshelfAPI.check(bookData.book_id, bookData.interface);
                        
                        if (inBookshelf) {
                            // ä»ä¹¦æ¶ç§»é™¤
                            await BookshelfAPI.remove(bookData.book_id, bookData.interface);
                            this.classList.remove('in-bookshelf');
                            this.title = 'åŠ å…¥ä¹¦æ¶';
                            showToast('å·²ä»ä¹¦æ¶ç§»é™¤', 'success');
                        } else {
                            // æ·»åŠ åˆ°ä¹¦æ¶
                            await BookshelfAPI.add(bookData);
                            this.classList.add('in-bookshelf');
                            this.title = 'å·²åœ¨ä¹¦æ¶ä¸­';
                            showToast('å·²åŠ å…¥ä¹¦æ¶', 'success');
                        }
                        
                        // è§¦å‘ä¹¦æ¶æ›´æ–°äº‹ä»¶
                        window.dispatchEvent(new CustomEvent('bookshelfUpdated'));
                    } catch (error) {
                        console.error('ä¹¦æ¶æ“ä½œå¤±è´¥:', error);
                        showToast(error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·å…ˆç™»å½•', 'error');
                    }
                });
            }
        });
        
        // è‡ªå®šä¹‰é¡µç è·³è½¬åŠŸèƒ½
        const goBtn = document.getElementById('go-btn');
        if (goBtn) {
            goBtn.addEventListener('click', function() {
            const pageInput = document.getElementById('page-input');
            const targetPage = parseInt(pageInput.value);
            const maxPage = parseInt('{{ pagination.total_pages }}');
            
            if (isNaN(targetPage) || targetPage < 1 || targetPage > maxPage) {
                alert(`è¯·è¾“å…¥1åˆ°${maxPage}ä¹‹é—´çš„æœ‰æ•ˆé¡µç `);
                pageInput.value = '{{ pagination.current_page }}';
                return;
            }
            
                // è·³è½¬åˆ°ç›®æ ‡é¡µç 
                window.location.href = `?page=${targetPage}`;
            });
            
            // å›è½¦é”®è§¦å‘è·³è½¬
            const pageInput = document.getElementById('page-input');
            if (pageInput) {
                pageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        goBtn.click();
                    }
                });
            }
        }
    </script>
    <script src="/static/js/global-player.js"></script>
    
    <!-- å…¨å±€æµ®åŠ¨æ’­æ”¾å™¨ï¼ˆç”± global-player.js è‡ªåŠ¨åˆ›å»ºï¼‰ -->
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="bottom-navbar">
        <div class="bottom-navbar-container">
            <a href="/" class="nav-item">
                <span class="nav-item-icon">ğŸ </span>
                <span class="nav-item-text">é¦–é¡µ</span>
            </a>
            <a href="/history" class="nav-item">
                <span class="nav-item-icon">ğŸ“œ</span>
                <span class="nav-item-text">å†å²</span>
            </a>
            <a href="/profile" class="nav-item">
                <span class="nav-item-icon">ğŸ‘¤</span>
                <span class="nav-item-text">æˆ‘çš„</span>
            </a>
        </div>
    </nav>
</body>
</html>