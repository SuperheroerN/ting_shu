<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="æœ‰å£°ä¹¦æœç´¢å’Œæ’­æ”¾å¹³å°">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æœ‰å£°ä¹¦">
    <title>æœç´¢ç»“æœ - æœ‰å£°ä¹¦æœç´¢</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/results.css">
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/announcement.css">
    <link rel="stylesheet" href="/static/css/global-player.css">
</head>
<body>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth-guard.js"></script>
    <script src="/static/js/announcement.js"></script>
    <script src="/static/js/pwa-install.js"></script>
    <div class="container">
        <header>
            <h1>æœ‰å£°ä¹¦æœç´¢</h1>
            <a href="/" class="home-link">è¿”å›é¦–é¡µ</a>
        </header>
        
        <script>
            // ä¿å­˜å½“å‰æœç´¢å…³é”®è¯åˆ°localStorage
            document.addEventListener('DOMContentLoaded', function() {
                const urlParams = new URLSearchParams(window.location.search);
                const keyword = urlParams.get('keyword');
                
                if (keyword) {
                    localStorage.setItem('lastSearchKeyword', keyword);
                    console.log('å·²ä¿å­˜æœç´¢å…³é”®è¯:', keyword);
                }
            });
        </script>
        
        <div class="main-content">
            <aside class="sidebar">
                <h2>æ˜¾ç¤ºæ¨¡å¼</h2>
                <div class="interface-list" id="interface-list">
                    <div class="interface-item active" data-mode="all">
                        <span class="interface-name">å…¨éƒ¨æ˜¾ç¤º</span>
                        <span class="interface-desc">æ˜¾ç¤ºæ‰€æœ‰æ¥å£æœç´¢ç»“æœ</span>
                    </div>
                    <!-- æ¥å£åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </aside>
            
            <main class="content">
                <div class="search-info">
                    <h2>æœç´¢ç»“æœ</h2>
                    <p>å…³é”®è¯ï¼š<strong>{{ keyword }}</strong></p>
                    <p>å…±æ‰¾åˆ° <strong>{{ total_books }}</strong> æœ¬ä¹¦</p>
                </div>
                
                <div class="results-section">
                    <div id="results" class="book-list">
                        {% for book in books %}
                        <div class="book-card" data-interface="{{ book.interface }}" onclick="location.href='/detail/{{ book.id }}/{{ book.interface }}'">
                            <div class="book-image">
                                <img src="{{ book.bookImage }}" alt="{{ book.bookTitle }}" onerror="this.src='https://via.placeholder.com/180x254?text=å°é¢ç¼ºå¤±'">
                                <div class="interface-badge {{ book.interface }}">{{ book.interface }}æ¥å£</div>
                            </div>
                            <div class="book-info">
                                <h3 class="book-title">{{ book.bookTitle }}</h3>
                                <p class="book-anchor">ä¸»æ’­: {{ book.bookAnchor }}</p>
                                <div class="book-stats">
                                    <span class="chapter-count">ç« èŠ‚: {{ book.count }}</span>
                                </div>
                                <p class="book-desc">{{ book.bookDesc[:15] }}...</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="no-results" style="display: none; text-align: center; margin: 2rem 0;">æœªæ‰¾åˆ°ç›¸å…³ä¹¦ç±</div>
                </div>
            </main>
        </div>
    </div>

    <script src="/static/js/request-auth.js"></script>
    <script src="/static/js/global-player.js"></script>
    <script>
        // åŠ è½½æ¥å£åˆ—è¡¨
        async function loadInterfaces() {
            try {
                const response = await fetch('/api/interfaces/list');
                const data = await response.json();
                
                if (data.success && data.interfaces) {
                    const interfaceList = document.getElementById('interface-list');
                    if (!interfaceList) return;
                    
                    // ä¿ç•™"å…¨éƒ¨æ˜¾ç¤º"é€‰é¡¹
                    const allItem = interfaceList.querySelector('[data-mode="all"]');
                    interfaceList.innerHTML = '';
                    if (allItem) {
                        interfaceList.appendChild(allItem);
                    } else {
                        // å¦‚æœæ²¡æœ‰"å…¨éƒ¨æ˜¾ç¤º"ï¼Œåˆ›å»ºä¸€ä¸ª
                        const allItemNew = document.createElement('div');
                        allItemNew.className = 'interface-item active';
                        allItemNew.setAttribute('data-mode', 'all');
                        allItemNew.innerHTML = `
                            <span class="interface-name">å…¨éƒ¨æ˜¾ç¤º</span>
                            <span class="interface-desc">æ˜¾ç¤ºæ‰€æœ‰æ¥å£æœç´¢ç»“æœ</span>
                        `;
                        interfaceList.appendChild(allItemNew);
                    }
                    
                    // æ·»åŠ å„ä¸ªæ¥å£é€‰é¡¹
                    data.interfaces.forEach(interface => {
                        const item = document.createElement('div');
                        item.className = 'interface-item';
                        item.setAttribute('data-mode', interface.interface_name);
                        item.innerHTML = `
                            <span class="interface-name">${interface.display_name}</span>
                            <span class="interface-desc">ä»…æ˜¾ç¤º${interface.display_name}æœç´¢ç»“æœ</span>
                        `;
                        interfaceList.appendChild(item);
                    });
                    
                    // é‡æ–°ç»‘å®šäº‹ä»¶
                    bindInterfaceItems();
                } else {
                    console.error('åŠ è½½æ¥å£åˆ—è¡¨å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('åŠ è½½æ¥å£åˆ—è¡¨å‡ºé”™:', error);
            }
        }
        
        // ç»‘å®šæ¥å£é€‰æ‹©äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜é¿å…é‡å¤ç»‘å®šï¼‰
        function bindInterfaceItems() {
            const interfaceList = document.getElementById('interface-list');
            if (!interfaceList) return;
            
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const newInterfaceList = interfaceList.cloneNode(true);
            interfaceList.parentNode.replaceChild(newInterfaceList, interfaceList);
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜
            newInterfaceList.addEventListener('click', function(e) {
                const item = e.target.closest('.interface-item');
                if (!item) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
                const allItems = newInterfaceList.querySelectorAll('.interface-item');
                allItems.forEach(i => i.classList.remove('active'));
                // æ·»åŠ å½“å‰æ´»è·ƒçŠ¶æ€
                item.classList.add('active');
                
                const mode = item.dataset.mode;
                const bookCards = document.querySelectorAll('.book-card');
                let visibleCount = 0;
                
                bookCards.forEach(card => {
                    if (mode === 'all' || card.dataset.interface === mode) {
                        card.style.display = 'flex';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                const noResults = document.getElementById('no-results');
                if (visibleCount === 0) {
                    if (noResults) {
                        noResults.style.display = 'block';
                        noResults.textContent = 'è¯¥æ¥å£ä¸‹æœªæ‰¾åˆ°ç›¸å…³ä¹¦ç±';
                    }
                } else {
                    if (noResults) {
                        noResults.style.display = 'none';
                    }
                }
                
                console.log('åˆ‡æ¢æ¥å£æ¨¡å¼:', mode, 'æ˜¾ç¤º', visibleCount, 'æœ¬ä¹¦');
            });
        }
        
        // æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆåŠ è½½æ¥å£åˆ—è¡¨
            loadInterfaces();
            
            // æ’­æ”¾æŒ‰é’®äº‹ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const playButtons = document.querySelectorAll('.play-btn');
            if (playButtons.length > 0) {
                playButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const bookId = this.dataset.bookid;
                        const chapterId = this.dataset.chapterid;
                        // ä»æŒ‰é’®æ‰€åœ¨çš„ä¹¦æœ¬å¡ç‰‡è·å–interface
                        const bookCard = this.closest('.book-card');
                        const interface = bookCard ? bookCard.dataset.interface || 'lam' : 'lam';
                        
                        authenticatedFetch('/get_chapter', {
                            bookId: bookId,
                            chapterId: chapterId,
                            interface: interface
                        }).then(data => {
                            if (data.error) {
                                alert(data.error);
                            } else {
                                // åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨
                                const audioPlayer = document.createElement('audio');
                                audioPlayer.src = data.url;
                                audioPlayer.controls = true;
                                audioPlayer.autoplay = true;
                                
                                // æ˜¾ç¤ºæ’­æ”¾å™¨
                                const playerDiv = document.createElement('div');
                                playerDiv.className = 'audio-player';
                                playerDiv.appendChild(audioPlayer);
                                
                                // æ›¿æ¢æ’­æ”¾æŒ‰é’®ä¸ºæ’­æ”¾å™¨
                                this.parentNode.replaceChild(playerDiv, this);
                            }
                        })
                        .catch(error => {
                            console.error('è·å–ç« èŠ‚å¤±è´¥:', error);
                            alert('è·å–ç« èŠ‚å¤±è´¥ï¼Œè¯·é‡è¯•');
                        });
                    });
                });
            }
        });
    </script>
    
    <!-- å…¨å±€æµ®åŠ¨æ’­æ”¾å™¨ï¼ˆç”± global-player.js è‡ªåŠ¨åˆ›å»ºï¼‰ -->
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="bottom-navbar">
        <div class="bottom-navbar-container">
            <a href="/" class="nav-item">
                <span class="nav-item-icon">ğŸ </span>
                <span class="nav-item-text">é¦–é¡µ</span>
            </a>
            <a href="/history" class="nav-item">
                <span class="nav-item-icon">ğŸ“œ</span>
                <span class="nav-item-text">å†å²</span>
            </a>
            <a href="/profile" class="nav-item">
                <span class="nav-item-icon">ğŸ‘¤</span>
                <span class="nav-item-text">æˆ‘çš„</span>
            </a>
        </div>
    </nav>
</body>
</html>