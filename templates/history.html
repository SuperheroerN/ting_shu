<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="æœ‰å£°ä¹¦æœç´¢å’Œæ’­æ”¾å¹³å°">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æœ‰å£°ä¹¦">
    <title>æ’­æ”¾å†å² - æœ‰å£°ä¹¦æœç´¢</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/history.css">
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/announcement.css">
    <link rel="stylesheet" href="/static/css/global-player.css">
</head>
<body>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth-guard.js"></script>
    <script src="/static/js/announcement.js"></script>
    <div class="container">
        <header>
            <h1>æ’­æ”¾å†å²</h1>
        </header>
        
        <div class="history-content">
            <div class="history-header">
                <h2>æœ€è¿‘æ’­æ”¾</h2>
                <button id="clear-history-btn" class="clear-btn">æ¸…ç©ºå†å²</button>
            </div>
            
            <div id="history-list" class="history-list">
                <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <div id="no-history" class="no-history" style="display: none;">
                <p>æš‚æ— æ’­æ”¾å†å²</p>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±€æµ®åŠ¨æ’­æ”¾å™¨ï¼ˆç”± global-player.js è‡ªåŠ¨åˆ›å»ºï¼‰ -->
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="bottom-navbar">
        <div class="bottom-navbar-container">
            <a href="/" class="nav-item">
                <span class="nav-item-icon">ğŸ </span>
                <span class="nav-item-text">é¦–é¡µ</span>
            </a>
            <a href="/history" class="nav-item active">
                <span class="nav-item-icon">ğŸ“œ</span>
                <span class="nav-item-text">å†å²</span>
            </a>
            <a href="/profile" class="nav-item">
                <span class="nav-item-icon">ğŸ‘¤</span>
                <span class="nav-item-text">æˆ‘çš„</span>
            </a>
        </div>
    </nav>
    
    <script>
        // æ¸²æŸ“æ’­æ”¾å†å²ï¼ˆä½¿ç”¨APIï¼‰
        async function renderHistory() {
            const historyList = document.getElementById('history-list');
            const noHistory = document.getElementById('no-history');
            
            try {
                const response = await HistoryAPI.get();
                const history = response.history || [];
                
                // å¦‚æœæ˜¯æœ¬åœ°æ•°æ®ä¸”ç”¨æˆ·å·²ç™»å½•ï¼Œæç¤ºåŒæ­¥
                if (response.is_local) {
                    try {
                        const status = await AuthAPI.getStatus();
                        if (status.logged_in && history.length > 0) {
                            // å°è¯•åŒæ­¥
                            await HistoryAPI.sync();
                            // åŒæ­¥åé‡æ–°è·å–
                            const newResponse = await HistoryAPI.get();
                            history = newResponse.history || [];
                        }
                    } catch (syncError) {
                        console.error('åŒæ­¥å†å²è®°å½•å¤±è´¥:', syncError);
                    }
                }
                
                if (history.length === 0) {
                    historyList.style.display = 'none';
                    noHistory.style.display = 'block';
                    return;
                }
                
                historyList.style.display = 'block';
                noHistory.style.display = 'none';
                
                historyList.innerHTML = history.map((item) => {
                    // å¤„ç†æ’­æ”¾æ—¶é—´ï¼ˆå…¼å®¹æ•°æ®åº“å’Œæœ¬åœ°æ ¼å¼ï¼‰
                    let playTime;
                    try {
                        const timeStr = item.play_time || item.playTime;
                        if (timeStr) {
                            playTime = new Date(timeStr);
                        } else {
                            playTime = new Date();
                        }
                    } catch {
                        playTime = new Date();
                    }
                    
                    const timeStr = playTime.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // æœ¬åœ°æ•°æ®å¯èƒ½æ²¡æœ‰idï¼Œä½¿ç”¨ç´¢å¼•
                    const itemId = item.id !== undefined ? item.id : item.index || 0;
                    
                    return `
                        <div class="history-item" data-book-id="${item.book_id}" data-interface="${item.interface}" data-chapter-id="${item.chapter_id}">
                            <div class="history-book-cover">
                                <img src="${item.book_image || 'https://via.placeholder.com/80x110?text=å°é¢ç¼ºå¤±'}" 
                                     alt="${item.book_title}" 
                                     onerror="this.src='https://via.placeholder.com/80x110?text=å°é¢ç¼ºå¤±'">
                            </div>
                            <div class="history-book-info">
                                <h3 class="history-book-title">${item.book_title}</h3>
                                <p class="history-chapter-title">${item.chapter_title}</p>
                                <p class="history-play-time">${timeStr}</p>
                            </div>
                            <div class="history-actions">
                                <button class="history-delete-btn" onclick="event.stopPropagation(); deleteHistory(${itemId})" title="åˆ é™¤">Ã—</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
                historyList.style.display = 'none';
                noHistory.style.display = 'block';
                
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                try {
                    const status = await AuthAPI.getStatus();
                    if (status.logged_in) {
                        noHistory.innerHTML = '<p>è·å–å†å²è®°å½•å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
                    } else {
                        noHistory.innerHTML = '<p>è·å–å†å²è®°å½•å¤±è´¥ï¼Œè¯·å…ˆç™»å½•</p>';
                    }
                } catch {
                noHistory.innerHTML = '<p>è·å–å†å²è®°å½•å¤±è´¥ï¼Œè¯·å…ˆç™»å½•</p>';
                }
            }
        }
        
        // åˆ é™¤å†å²è®°å½•
        async function deleteHistory(historyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await HistoryAPI.delete(historyId);
                renderHistory();
            } catch (error) {
                console.error('åˆ é™¤å†å²è®°å½•å¤±è´¥:', error);
                alert(error.message || 'åˆ é™¤å¤±è´¥');
            }
        }
        
        // æ¸…ç©ºå†å²
        document.getElementById('clear-history-btn').addEventListener('click', async function() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ’­æ”¾å†å²å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await HistoryAPI.clear();
                renderHistory();
            } catch (error) {
                console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', error);
                alert(error.message || 'æ¸…ç©ºå¤±è´¥');
            }
        });
        
        // å†å²è®°å½•é¡¹ç‚¹å‡»äº‹ä»¶ï¼ˆå¸¦åŠ è½½æç¤ºï¼‰
        document.addEventListener('click', function(e) {
            const historyItem = e.target.closest('.history-item');
            if (historyItem && !e.target.closest('.history-delete-btn')) {
                e.preventDefault();
                e.stopPropagation();
                
                // æ·»åŠ ç‚¹å‡»åé¦ˆ
                historyItem.style.opacity = '0.6';
                historyItem.style.transform = 'scale(0.98)';
                
                // æ˜¾ç¤ºåŠ è½½æç¤º
                const loadingTip = document.createElement('div');
                loadingTip.id = 'history-loading-tip';
                loadingTip.textContent = 'æ­£åœ¨åŠ è½½...';
                loadingTip.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-size: 14px;
                    pointer-events: none;
                    animation: fadeIn 0.2s;
                `;
                document.body.appendChild(loadingTip);
                
                // è·å–è·³è½¬ä¿¡æ¯
                const bookId = historyItem.dataset.bookId;
                const interface = historyItem.dataset.interface;
                const chapterId = historyItem.dataset.chapterId;
                
                // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
                setTimeout(() => {
                    window.location.href = `/player/${bookId}/${interface}/${chapterId}`;
                }, 150);
            }
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderHistory();
        });
    </script>
    <script src="/static/js/global-player.js"></script>
    <script src="/static/js/pwa-install.js"></script>
</body>
</html>

