<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="æœ‰å£°ä¹¦æœç´¢å’Œæ’­æ”¾å¹³å°">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æœ‰å£°ä¹¦">
    <title>ä¸ªäººä¸­å¿ƒ - æœ‰å£°ä¹¦æœç´¢</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/profile.css">
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/announcement.css">
    <link rel="stylesheet" href="/static/css/global-player.css">
</head>
<body>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/request-auth.js"></script>
    <script src="/static/js/auth-guard.js"></script>
    <script src="/static/js/announcement.js"></script>
    <script src="/static/js/pwa-install.js"></script>
    <div class="container">
        <header>
            <h1>ä¸ªäººä¸­å¿ƒ</h1>
        </header>
        
        <div class="profile-content">
            <!-- ç™»å½•/æœªç™»å½•çŠ¶æ€ -->
            <div id="login-section" class="login-section">
                <div class="login-card">
                    <h2>ç™»å½•</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="username">ç”¨æˆ·å</label>
                            <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                        </div>
                        <div class="form-group">
                            <label for="password">å¯†ç </label>
                            <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="remember-login" checked>
                                è®°ä½è´¦å·å¯†ç å¹¶è‡ªåŠ¨ç™»å½•ï¼ˆä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">ç™»å½•</button>
                            <button type="button" id="show-register-btn" class="btn btn-secondary">æ³¨å†Œ</button>
                            <button type="button" id="clear-cache-btn" class="btn btn-secondary">æ¸…é™¤å·²è®°ä½è´¦å·</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- æ³¨å†Œå¼¹çª— -->
            <div id="register-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>æ³¨å†Œæ–°è´¦å·</h2>
                        <button class="modal-close" id="close-register-modal">&times;</button>
                    </div>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="register-username">ç”¨æˆ·å</label>
                            <input type="text" id="register-username" name="register-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">å¯†ç </label>
                            <input type="password" id="register-password" name="register-password" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password-confirm">ç¡®è®¤å¯†ç </label>
                            <input type="password" id="register-password-confirm" name="register-password-confirm" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                            <button type="button" class="btn btn-secondary" id="cancel-register-btn">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- å·²ç™»å½•çŠ¶æ€ -->
            <div id="user-section" class="user-section" style="display: none;">
                <div class="user-info-card">
                    <div class="user-avatar">
                        <span class="avatar-icon">ğŸ‘¤</span>
                    </div>
                    <h2 id="user-name">ç”¨æˆ·å</h2>
                    <button id="logout-btn" class="logout-btn">é€€å‡ºç™»å½•</button>
                </div>
                
                <div class="stats-section">
                    <h3>å¬ä¹¦ç»Ÿè®¡</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="total-books">0</div>
                            <div class="stat-label">å¬è¿‡ä¹¦ç±</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-chapters">0</div>
                            <div class="stat-label">å¬è¿‡ç« èŠ‚</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-time">0å°æ—¶</div>
                            <div class="stat-label">å¬ä¹¦æ—¶é•¿</div>
                        </div>
                    </div>
                </div>
                
                <div class="recent-books-section">
                    <h3>æœ€è¿‘å¬çš„ä¹¦ç±</h3>
                    <div id="recent-books-list" class="recent-books-list">
                        <!-- æœ€è¿‘å¬çš„ä¹¦ç±å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±€æµ®åŠ¨æ’­æ”¾å™¨ï¼ˆç”± global-player.js è‡ªåŠ¨åˆ›å»ºï¼‰ -->
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="bottom-navbar">
        <div class="bottom-navbar-container">
            <a href="/" class="nav-item">
                <span class="nav-item-icon">ğŸ </span>
                <span class="nav-item-text">é¦–é¡µ</span>
            </a>
            <a href="/history" class="nav-item">
                <span class="nav-item-icon">ğŸ“œ</span>
                <span class="nav-item-text">å†å²</span>
            </a>
            <a href="/profile" class="nav-item active">
                <span class="nav-item-icon">ğŸ‘¤</span>
                <span class="nav-item-text">æˆ‘çš„</span>
            </a>
        </div>
    </nav>
    
    <script>
        // è·å–ç™»å½•åè·³è½¬ç›®æ ‡
        function getNextPage() {
            const params = new URLSearchParams(window.location.search);
            const next = params.get('next');
            if (next && next !== '/profile') {
                return next;
            }
            return null;
        }

        // æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨APIï¼‰
        async function renderUserInfo() {
            const loginSection = document.getElementById('login-section');
            const userSection = document.getElementById('user-section');
            
            try {
                const status = await AuthAPI.getStatus();
                
                if (status.logged_in && status.user) {
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼Œéšè—ç™»å½•åŒºåŸŸ
                    loginSection.style.display = 'none';
                    userSection.style.display = 'block';
                    
                    // è®¾ç½®ç”¨æˆ·å
                    document.getElementById('user-name').textContent = status.user.username;
                    
                    // è·å–ç»Ÿè®¡æ•°æ®ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿè¦æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼‰
                    try {
                    const statsResponse = await StatsAPI.get();
                        const stats = statsResponse.stats || {};
                    const recentBooks = statsResponse.recent_books || [];
                    
                        // æ›´æ–°ç»Ÿè®¡æ•°æ®
                        document.getElementById('total-books').textContent = stats.total_books || 0;
                        document.getElementById('total-chapters').textContent = stats.total_chapters || 0;
                        document.getElementById('total-time').textContent = (stats.total_hours || 0) + 'å°æ—¶';
                    
                    // æ¸²æŸ“æœ€è¿‘å¬çš„ä¹¦ç±
                    const recentBooksList = document.getElementById('recent-books-list');
                    
                    if (recentBooks.length === 0) {
                        recentBooksList.innerHTML = '<p class="no-recent-books">æš‚æ— æœ€è¿‘å¬çš„ä¹¦ç±</p>';
                    } else {
                        recentBooksList.innerHTML = recentBooks.map(book => `
                            <div class="recent-book-card" onclick="location.href='/detail/${book.book_id}/${book.interface}'">
                                <div class="recent-book-cover">
                                    <img src="${book.book_image || 'https://via.placeholder.com/60x80?text=å°é¢ç¼ºå¤±'}" 
                                         alt="${book.book_title}" 
                                         onerror="this.src='https://via.placeholder.com/60x80?text=å°é¢ç¼ºå¤±'">
                                </div>
                                <div class="recent-book-name">${book.book_title}</div>
                            </div>
                        `).join('');
                        }
                    } catch (statsError) {
                        console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', statsError);
                        // å³ä½¿ç»Ÿè®¡å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºé»˜è®¤å€¼
                        document.getElementById('total-books').textContent = '0';
                        document.getElementById('total-chapters').textContent = '0';
                        document.getElementById('total-time').textContent = '0å°æ—¶';
                        document.getElementById('recent-books-list').innerHTML = '<p class="no-recent-books">æš‚æ— æœ€è¿‘å¬çš„ä¹¦ç±</p>';
                    }
                } else {
                    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢
                    loginSection.style.display = 'block';
                    userSection.style.display = 'none';
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                // å‡ºé”™æ—¶æ˜¾ç¤ºç™»å½•ç•Œé¢
                loginSection.style.display = 'block';
                userSection.style.display = 'none';
            }
        }
        
        // ç™»å½•åŠŸèƒ½
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const remember = document.getElementById('remember-login').checked;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            try {
                await AuthAPI.login(username, password, { remember });
                // æ¸…ç©ºç™»å½•è¡¨å•
                document.getElementById('login-form').reset();
                document.getElementById('remember-login').checked = remember;
                
                // åŒæ­¥æœ¬åœ°æ•°æ®åˆ°æ•°æ®åº“ï¼ˆåŒå‘åŒæ­¥ï¼‰
                try {
                    // 1. åŒæ­¥ä¹¦æ¶æ•°æ®ï¼ˆä¸Šä¼ æœ¬åœ°æ•°æ®ï¼Œç„¶åä¸‹è½½æœåŠ¡å™¨æ•°æ®åˆ°æœ¬åœ°ï¼‰
                    console.log('å¼€å§‹åŒæ­¥ä¹¦æ¶æ•°æ®...');
                    const bookshelfSyncResult = await BookshelfAPI.sync();
                    console.log('ä¹¦æ¶åŒæ­¥ç»“æœ:', bookshelfSyncResult);
                    if (bookshelfSyncResult && bookshelfSyncResult.synced_count > 0) {
                        console.log(`æˆåŠŸåŒæ­¥ ${bookshelfSyncResult.synced_count} æœ¬ä¹¦åˆ°æ•°æ®åº“`);
                    }
                    
                    // 2. åŒæ­¥å†å²è®°å½•ï¼ˆä¸Šä¼ æœ¬åœ°æ•°æ®ï¼Œç„¶åä¸‹è½½æœåŠ¡å™¨æ•°æ®åˆ°æœ¬åœ°ï¼‰
                    console.log('å¼€å§‹åŒæ­¥å†å²è®°å½•...');
                    const historySyncResult = await HistoryAPI.sync();
                    console.log('å†å²è®°å½•åŒæ­¥ç»“æœ:', historySyncResult);
                    if (historySyncResult && historySyncResult.synced_count > 0) {
                        console.log(`æˆåŠŸåŒæ­¥ ${historySyncResult.synced_count} æ¡å†å²è®°å½•åˆ°æ•°æ®åº“`);
                    }
                    
                    console.log('æ•°æ®åŒæ­¥å®Œæˆï¼Œæœ¬åœ°ç¼“å­˜å·²æ›´æ–°');
                } catch (syncError) {
                    console.error('åŒæ­¥æ•°æ®å¤±è´¥:', syncError);
                    // åŒæ­¥å¤±è´¥ä¸å½±å“ç™»å½•æµç¨‹ï¼Œä½†è®°å½•é”™è¯¯
                }
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                const nextPage = getNextPage();
                if (nextPage) {
                    window.location.href = nextPage;
                    return;
                }
                await renderUserInfo();
                // ä¸æ˜¾ç¤ºalertï¼Œç›´æ¥åˆ‡æ¢ç•Œé¢æ›´æµç•…
            } catch (error) {
                alert(error.message || 'ç™»å½•å¤±è´¥');
            }
        });
        
        // æ˜¾ç¤ºæ³¨å†Œå¼¹çª—
        document.getElementById('show-register-btn').addEventListener('click', function() {
            const modal = document.getElementById('register-modal');
            modal.style.display = 'block';
            // æ¸…ç©ºæ³¨å†Œè¡¨å•
            document.getElementById('register-form').reset();
        });
        
        // å…³é—­æ³¨å†Œå¼¹çª—
        function closeRegisterModal() {
            const modal = document.getElementById('register-modal');
            modal.style.display = 'none';
            document.getElementById('register-form').reset();
        }
        
        document.getElementById('close-register-modal').addEventListener('click', closeRegisterModal);
        document.getElementById('cancel-register-btn').addEventListener('click', closeRegisterModal);
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('register-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRegisterModal();
            }
        });
        
        // æ³¨å†ŒåŠŸèƒ½
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const passwordConfirm = document.getElementById('register-password-confirm').value.trim();
            
            // éªŒè¯ç”¨æˆ·å
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            if (username.length < 3 || username.length > 20) {
                alert('ç”¨æˆ·åé•¿åº¦åº”åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´');
                return;
            }
            
            // éªŒè¯å¯†ç 
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }
            
            if (password.length < 6) {
                alert('å¯†ç é•¿åº¦è‡³å°‘6ä½');
                return;
            }
            
            // éªŒè¯ç¡®è®¤å¯†ç 
            if (password !== passwordConfirm) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            try {
                await AuthAPI.register(username, password, { remember: true });
                closeRegisterModal();
                
                // åŒæ­¥æœ¬åœ°æ•°æ®åˆ°æ•°æ®åº“ï¼ˆåŒå‘åŒæ­¥ï¼‰
                try {
                    // 1. åŒæ­¥ä¹¦æ¶æ•°æ®ï¼ˆä¸Šä¼ æœ¬åœ°æ•°æ®ï¼Œç„¶åä¸‹è½½æœåŠ¡å™¨æ•°æ®åˆ°æœ¬åœ°ï¼‰
                    console.log('å¼€å§‹åŒæ­¥ä¹¦æ¶æ•°æ®...');
                    const bookshelfSyncResult = await BookshelfAPI.sync();
                    console.log('ä¹¦æ¶åŒæ­¥ç»“æœ:', bookshelfSyncResult);
                    if (bookshelfSyncResult && bookshelfSyncResult.synced_count > 0) {
                        console.log(`æˆåŠŸåŒæ­¥ ${bookshelfSyncResult.synced_count} æœ¬ä¹¦åˆ°æ•°æ®åº“`);
                    }
                    
                    // 2. åŒæ­¥å†å²è®°å½•ï¼ˆä¸Šä¼ æœ¬åœ°æ•°æ®ï¼Œç„¶åä¸‹è½½æœåŠ¡å™¨æ•°æ®åˆ°æœ¬åœ°ï¼‰
                    console.log('å¼€å§‹åŒæ­¥å†å²è®°å½•...');
                    const historySyncResult = await HistoryAPI.sync();
                    console.log('å†å²è®°å½•åŒæ­¥ç»“æœ:', historySyncResult);
                    if (historySyncResult && historySyncResult.synced_count > 0) {
                        console.log(`æˆåŠŸåŒæ­¥ ${historySyncResult.synced_count} æ¡å†å²è®°å½•åˆ°æ•°æ®åº“`);
                    }
                    
                    console.log('æ•°æ®åŒæ­¥å®Œæˆï¼Œæœ¬åœ°ç¼“å­˜å·²æ›´æ–°');
                } catch (syncError) {
                    console.error('åŒæ­¥æ•°æ®å¤±è´¥:', syncError);
                    // åŒæ­¥å¤±è´¥ä¸å½±å“æ³¨å†Œæµç¨‹ï¼Œä½†è®°å½•é”™è¯¯
                }
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                const nextPage = getNextPage();
                if (nextPage) {
                    window.location.href = nextPage;
                    return;
                }
                await renderUserInfo();
                // ä¸æ˜¾ç¤ºalertï¼Œç›´æ¥åˆ‡æ¢ç•Œé¢æ›´æµç•…
            } catch (error) {
                alert(error.message || 'æ³¨å†Œå¤±è´¥');
            }
        });
        
        // é€€å‡ºç™»å½•
        document.getElementById('logout-btn').addEventListener('click', async function() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                // é€€å‡ºå‰ï¼Œå…ˆåŒæ­¥æœåŠ¡å™¨æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜
                console.log('é€€å‡ºç™»å½•å‰ï¼ŒåŒæ­¥æœåŠ¡å™¨æ•°æ®åˆ°æœ¬åœ°...');
                try {
                    // 1. åŒæ­¥ä¹¦æ¶æ•°æ®åˆ°æœ¬åœ°
                    const bookshelfData = await BookshelfAPI.get();
                    if (bookshelfData && bookshelfData.books && bookshelfData.books.length > 0) {
                        localStorage.setItem('bookshelf', JSON.stringify(bookshelfData.books));
                        console.log('å·²ç¼“å­˜ä¹¦æ¶æ•°æ®åˆ°æœ¬åœ°ï¼Œå…±', bookshelfData.books.length, 'æœ¬');
                    }
                    
                    // 2. åŒæ­¥å†å²è®°å½•åˆ°æœ¬åœ°
                    const historyData = await HistoryAPI.get();
                    if (historyData && historyData.history && historyData.history.length > 0) {
                        // å°†æœåŠ¡å™¨æ•°æ®è½¬æ¢ä¸ºæœ¬åœ°æ ¼å¼
                        const localFormat = historyData.history.map(item => ({
                            book_id: item.book_id,
                            interface: item.interface,
                            chapter_id: item.chapter_id,
                            chapter_title: item.chapter_title || '',
                            book_title: item.book_title || '',
                            book_image: item.book_image || '',
                            book_anchor: item.book_anchor || '',
                            playTime: item.play_time || new Date().toISOString()
                        }));
                        localStorage.setItem('playHistory', JSON.stringify(localFormat));
                        console.log('å·²ç¼“å­˜å†å²è®°å½•åˆ°æœ¬åœ°ï¼Œå…±', localFormat.length, 'æ¡');
                    }
                    
                    console.log('æ•°æ®å·²åŒæ­¥åˆ°æœ¬åœ°ç¼“å­˜');
                } catch (syncError) {
                    console.error('åŒæ­¥æ•°æ®åˆ°æœ¬åœ°å¤±è´¥:', syncError);
                    // å³ä½¿åŒæ­¥å¤±è´¥ä¹Ÿç»§ç»­é€€å‡º
                }
                
                // æ‰§è¡Œé€€å‡ºç™»å½•
                await AuthAPI.logout({ clearCache: false });
                location.reload();
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                location.reload();
            }
        });

        // æ¸…é™¤å·²ç¼“å­˜çš„ç™»å½•ä¿¡æ¯
        document.getElementById('clear-cache-btn').addEventListener('click', function() {
            if (!window.AuthCache) return;
            AuthCache.clearCachedAuthCredentials();
            alert('å·²æ¸…é™¤æœ¬åœ°è®°ä½çš„è´¦å·å¯†ç ');
        });
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            let autoLoggedIn = false;
            // å°è¯•è‡ªåŠ¨ç™»å½•ä»¥ä¾¿æ— éœ€é‡å¤è¾“å…¥
            if (AuthAPI && AuthAPI.autoLoginFromCache) {
                const auto = await AuthAPI.autoLoginFromCache();
                autoLoggedIn = auto && auto.success;
            }
            await renderUserInfo();

            // æ ¹æ®åå°é…ç½®æ§åˆ¶æ³¨å†Œå…¥å£æ˜¾ç¤ºï¼ˆå¼€æ”¾æ³¨å†Œ / ç¦æ­¢æ³¨å†Œï¼‰
            try {
                if (AuthAPI && AuthAPI.getAuthConfig) {
                    const config = await AuthAPI.getAuthConfig();
                    const allowRegister = (config.allow_register !== false); // é»˜è®¤å…è®¸
                    const showRegisterBtn = document.getElementById('show-register-btn');
                    if (showRegisterBtn) {
                        showRegisterBtn.style.display = allowRegister ? 'inline-block' : 'none';
                    }
                }
            } catch (e) {
                console.warn('è·å–æ³¨å†Œé…ç½®å¤±è´¥ï¼Œä¿æŒé»˜è®¤æ˜¾ç¤ºæ³¨å†ŒæŒ‰é’®:', e);
            }

            // å¦‚æœæºå¸¦nextå‚æ•°ä¸”å·²ç™»å½•ï¼Œè‡ªåŠ¨è·³è½¬å›ç›®æ ‡é¡µ
            const nextPage = getNextPage();
            if (nextPage) {
                try {
                    const status = await AuthAPI.getStatus();
                    if (status.logged_in || autoLoggedIn) {
                        window.location.href = nextPage;
                    }
                } catch (e) {
                    // ignore
                }
            }
        });
    </script>
    <script src="/static/js/global-player.js"></script>
</body>
</html>

