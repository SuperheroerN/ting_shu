<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="æœ‰å£°ä¹¦æœç´¢å’Œæ’­æ”¾å¹³å°">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æœ‰å£°ä¹¦">
    {% if request.is_secure %}
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    {% endif %}
    <title>{{ chapter_title }} - æœ‰å£°ä¹¦æœç´¢</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/player.css">
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/announcement.css">
    <link rel="stylesheet" href="/static/css/global-player.css">
</head>
<body>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth-guard.js"></script>
    <script src="/static/js/request-auth.js"></script>
    <script src="/static/js/player-utils.js"></script>
    <script src="/static/js/player-enhancements.js"></script>
    <script src="/static/js/announcement.js"></script>
    <script src="/static/js/global-player.js"></script>
    <script src="/static/js/pwa-install.js"></script>
    
    <div class="container player-page-container">
        <header>
            <a href="/" class="home-link">é¦–é¡µ</a>
            <a id="back-to-results" href="#" class="back-link">ç»“æœ</a>
            <a href="/detail/{{ book_id }}/{{ interface }}" class="back-link">ç« èŠ‚</a>
        </header>
        
        <div class="player-content">
            <div class="player-book-info">
                <div class="player-book-cover">
                    <img src="{{ book_image }}" alt="{{ book_title }}" onerror="this.src='https://via.placeholder.com/200x300?text=å°é¢ç¼ºå¤±'">
                </div>
                <div class="player-book-meta">
                    <h2 class="player-book-title">{{ book_title }}</h2>
                    {% if book_anchor %}
                    <p class="player-book-anchor">ä¸»æ’­: {{ book_anchor }}</p>
                    {% endif %}
                    <div class="interface-badge-detail {{ interface }}">{{ interface }}æ¥å£</div>
                </div>
            </div>
            
            <div class="player-section">
                <h3 class="player-chapter-title">{{ chapter_title }}</h3>
                <p class="player-chapter-duration">æ—¶é•¿: {{ chapter_duration }}</p>
                
                <div class="audio-player-container">
                    <!-- ç»Ÿä¸€çš„æ’­æ”¾å™¨æ§ä»¶ -->
                    <div id="custom-player-controls" class="custom-player-controls">
                        <div class="player-control-section">
                            <button id="custom-play-pause-btn" class="custom-player-btn play-pause-btn">
                                <span class="play-icon">â–¶</span>
                                <span class="pause-icon">â¸</span>
                            </button>
                            
                            <div class="progress-container">
                                <span id="current-time" class="time-display">00:00</span>
                                <div class="progress-bar-wrapper">
                                    <div id="progress-bar" class="progress-bar">
                                        <div id="progress-filled" class="progress-filled"></div>
                                    </div>
                                </div>
                                <span id="duration" class="time-display">00:00</span>
                            </div>
                        </div>
                        
                        <div class="volume-control-section">
                            <button id="custom-mute-btn" class="custom-player-btn volume-btn">
                                <span class="volume-icon">ğŸ”Š</span>
                                <span class="muted-icon">ğŸ”‡</span>
                            </button>
                            <div class="volume-slider-container">
                                <input type="range" id="custom-volume-slider" class="volume-slider" min="0" max="1" step="0.01" value="1">
                            </div>
                        </div>
                    </div>
                    
                    <div id="audio-error" class="audio-error" style="display: none;">
                        <p>æ— æ³•è·å–éŸ³é¢‘URLï¼Œè¯·ç¨åé‡è¯•ã€‚</p>
                    </div>
                </div>
                
                <div class="player-controls-wrapper">
                <div class="player-controls">
                        <button id="prev-chapter-btn" class="player-btn prev-btn {% if not prev_chapter %}disabled{% endif %}" 
                                {% if prev_chapter %}data-chapter-id="{{ prev_chapter.chapter_id }}" data-chapter-title="{{ prev_chapter.title }}" data-chapter-duration="{{ prev_chapter.duration }}"{% endif %}
                                {% if not prev_chapter %}disabled{% endif %}>
                            <span class="btn-icon">â†</span>
                        </button>
                        
                        <button id="next-chapter-btn" class="player-btn next-btn {% if not next_chapter %}disabled{% endif %}" 
                                {% if next_chapter %}data-chapter-id="{{ next_chapter.chapter_id }}" data-chapter-title="{{ next_chapter.title }}" data-chapter-duration="{{ next_chapter.duration }}"{% endif %}
                                {% if not next_chapter %}disabled{% endif %}>
                            <span class="btn-icon">â†’</span>
                        </button>
                    </div>
                    
                    <div class="player-menu-wrapper">
                        <button id="advanced-menu-btn" class="player-btn menu-btn">
                            <span class="btn-text">èœå•</span>
                            <span class="btn-icon">â‹®</span>
                        </button>
                        
                        <div id="menu-list" class="player-menu-list hidden">
                            <div class="menu-item" data-menu="skip">
                                <span class="menu-icon">â©</span>
                                <span class="menu-text">è·³è¿‡ç‰‡å¤´å°¾</span>
                                <span class="menu-arrow">â€º</span>
                            </div>
                        </div>
                        
                        <div id="skip-settings" class="player-menu-panel hidden">
                            <div class="menu-panel-header">
                                <button class="menu-back-btn" data-back="menu">â† è¿”å›</button>
                                <h3>è·³è¿‡ç‰‡å¤´å°¾è®¾ç½®</h3>
                            </div>
                            <div class="menu-panel-content">
                                <div class="skip-setting-item">
                                    <label>
                                        <input type="checkbox" id="auto-skip-opening">
                                        è‡ªåŠ¨è·³è¿‡ç‰‡å¤´
                                    </label>
                                    <input type="number" id="skip-opening-input" min="0" max="300" value="0" placeholder="ç§’æ•°">
                                    <span>ç§’</span>
                                </div>
                                <div class="skip-setting-item">
                                    <label>
                                        <input type="checkbox" id="auto-skip-ending">
                                        è‡ªåŠ¨è·³è¿‡ç‰‡å°¾
                                    </label>
                                    <input type="number" id="skip-ending-input" min="0" max="300" value="0" placeholder="ç§’æ•°">
                                    <span>ç§’</span>
                                </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            'use strict';
            
            // ==================== ç»Ÿä¸€çš„éŸ³é¢‘ç¼“å­˜æ± ï¼ˆæœ€å¤š30ç« ï¼ŒæŒä¹…åŒ–ï¼‰ ====================
            class AudioCachePool {
                constructor() {
                    const { CONSTANTS } = window.PlayerUtils;
                    this.maxSize = CONSTANTS.CACHE_MAX_SIZE;
                    this.storageKey = CONSTANTS.CACHE_STORAGE_KEY;
                    this.cache = {};
                    this.stats = {
                        hits: 0,
                        misses: 0,
                        evictions: 0
                    };
                    this.batchStorage = new window.PlayerUtils.BatchStorage();
                    this.load();
                }
                
                load() {
                    try {
                        const saved = localStorage.getItem(this.storageKey);
                        if (saved) {
                            const data = JSON.parse(saved);
                            this.cache = data.cache || {};
                            console.log(`ç¼“å­˜æ± ï¼šä»localStorageæ¢å¤ ${Object.keys(this.cache).length} ä¸ªç« èŠ‚`);
                        }
                    } catch (e) {
                        console.error('ç¼“å­˜æ± ï¼šåŠ è½½å¤±è´¥:', e);
                        this.cache = {};
                    }
                }
                
                save() {
                    // ä½¿ç”¨æ‰¹é‡å­˜å‚¨å»¶è¿Ÿä¿å­˜
                    this.batchStorage.set(this.storageKey, { cache: this.cache, maxSize: this.maxSize });
                }
                
                flush() {
                    // ç«‹å³åˆ·æ–°åˆ°localStorage
                    this.batchStorage.flush();
                }
                
                getStats() {
                    const hitRate = this.stats.hits + this.stats.misses > 0
                        ? (this.stats.hits / (this.stats.hits + this.stats.misses) * 100).toFixed(2)
                        : 0;
                    return {
                        ...this.stats,
                        hitRate: hitRate + '%',
                        cacheSize: Object.keys(this.cache).length,
                        maxSize: this.maxSize
                    };
                }
                
                get(chapterId) {
                    const item = this.cache[chapterId];
                    if (item && item.url) {
                        item.lastAccess = Date.now();
                        item.accessCount = (item.accessCount || 0) + 1;
                        this.stats.hits++;
                        this.batchStorage.set(this.storageKey, this.cache);
                        return item.url;
                    }
                    this.stats.misses++;
                    return null;
                }
                
                add(chapterId, url, priority = 0) {
                    // LRU + Priority æ·˜æ±°ç­–ç•¥
                    const keys = Object.keys(this.cache);
                    if (keys.length >= this.maxSize && !this.cache[chapterId]) {
                        // è®¡ç®—æ¯ä¸ªé¡¹çš„å¾—åˆ†ï¼ˆè€ƒè™‘è®¿é—®é¢‘ç‡å’Œä¼˜å…ˆçº§ï¼‰
                        const scores = keys.map(key => {
                            const item = this.cache[key];
                            const age = Date.now() - (item.lastAccess || 0);
                            const accessCount = item.accessCount || 0;
                            const itemPriority = item.priority || 0;
                            return {
                                key,
                                score: itemPriority * 1000 + accessCount * 100 - age / 1000
                            };
                        });
                        scores.sort((a, b) => a.score - b.score);
                        delete this.cache[scores[0].key];
                        this.stats.evictions++;
                    }
                    
                    this.cache[chapterId] = {
                        url: url,
                        lastAccess: Date.now(),
                        accessCount: 0,
                        priority: priority,
                        addedAt: Date.now()
                    };
                    this.batchStorage.set(this.storageKey, this.cache);
                    console.log(`ç¼“å­˜æ± ï¼šå·²ç¼“å­˜ç« èŠ‚ ${chapterId}ï¼Œå½“å‰ç¼“å­˜æ•°: ${Object.keys(this.cache).length}`);
                }
                
                cleanOldCache(keepCount) {
                    const keys = Object.keys(this.cache);
                    if (keys.length <= keepCount) return;
                    
                    keys.sort((a, b) => (this.cache[a].lastAccess || 0) - (this.cache[b].lastAccess || 0));
                    for (let i = 0; i < keys.length - keepCount; i++) {
                        delete this.cache[keys[i]];
                    }
                }
            }
            
            // å…¨å±€ç¼“å­˜æ± å®ä¾‹
            if (!window.audioCachePool) {
                window.audioCachePool = new AudioCachePool();
            }
            
            // ==================== é¡µé¢é…ç½®å’ŒçŠ¶æ€ ====================
            const CONFIG = {
                bookId: '{{ book_id }}',
                interface: '{{ interface }}',
                chapterId: '{{ chapter_id }}',
                chapterTitle: '{{ chapter_title }}',
                bookTitle: '{{ book_title }}',
                bookImage: '{{ book_image }}',
                bookAnchor: '{{ book_anchor }}',
                prevChapter: {% if prev_chapter %}{{ prev_chapter|tojson|safe }}{% else %}null{% endif %},
                nextChapter: {% if next_chapter %}{{ next_chapter|tojson|safe }}{% else %}null{% endif %}
            };
            
            const state = {
                isSwitching: false,
                skipOpening: parseInt(localStorage.getItem('skipOpening') || '0'),
                skipEnding: parseInt(localStorage.getItem('skipEnding') || '0'),
                autoSkipOpening: localStorage.getItem('autoSkipOpening') === 'true',
                autoSkipEnding: localStorage.getItem('autoSkipEnding') === 'true',
                currentContext: null
            };
            
            // ==================== DOM å…ƒç´  ====================
            const elements = {
                audioError: document.getElementById('audio-error'),
                chapterTitle: document.querySelector('.player-chapter-title'),
                chapterDuration: document.querySelector('.player-chapter-duration'),
                playPauseBtn: document.getElementById('custom-play-pause-btn'),
                currentTime: document.getElementById('current-time'),
                duration: document.getElementById('duration'),
                progressBar: document.getElementById('progress-bar'),
                progressFilled: document.getElementById('progress-filled'),
                muteBtn: document.getElementById('custom-mute-btn'),
                volumeSlider: document.getElementById('custom-volume-slider'),
                prevBtn: document.getElementById('prev-chapter-btn'),
                nextBtn: document.getElementById('next-chapter-btn'),
                menuBtn: document.getElementById('advanced-menu-btn'),
                menuList: document.getElementById('menu-list'),
                skipPanel: document.getElementById('skip-settings'),
                skipOpeningInput: document.getElementById('skip-opening-input'),
                skipEndingInput: document.getElementById('skip-ending-input'),
                autoSkipOpening: document.getElementById('auto-skip-opening'),
                autoSkipEnding: document.getElementById('auto-skip-ending')
            };
            
            // ==================== å·¥å…·å‡½æ•° ====================
            function formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '00:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            async function getAudioUrl(chapterId) {
                // å…ˆæŸ¥ç¼“å­˜
                const cached = window.audioCachePool.get(chapterId);
                if (cached) {
                    console.log('ä½¿ç”¨ç¼“å­˜:', chapterId);
                    return cached;
                }
                
                // è°ƒç”¨API
                try {
                    const response = await authenticatedFetch('/get_chapter', {
                        bookId: CONFIG.bookId,
                        chapterId: chapterId,
                        interface: CONFIG.interface
                    });
                    
                    if (response.url) {
                        // å­˜å…¥ç¼“å­˜
                        window.audioCachePool.add(chapterId, response.url);
                        return response.url;
                    }
                    throw new Error('URLä¸ºç©º');
                } catch (error) {
                    console.error('è·å–éŸ³é¢‘URLå¤±è´¥:', error);
                    throw error;
                }
            }
            
            async function getChapterContext(chapterId) {
                try {
                    const response = await authenticatedFetch('/get_chapter_context', {
                        bookId: CONFIG.bookId,
                        chapterId: chapterId,
                        interface: CONFIG.interface
                    });
                    return response;
                } catch (error) {
                    console.error('è·å–ç« èŠ‚ä¸Šä¸‹æ–‡å¤±è´¥:', error);
                    return null;
                }
            }
            
            async function savePlayHistory(chapterId, chapterTitle) {
                try {
                    await HistoryAPI.add({
                        book_id: CONFIG.bookId,
                        interface: CONFIG.interface,
                        chapter_id: chapterId,
                        chapter_title: chapterTitle,
                        book_title: CONFIG.bookTitle,
                        book_image: CONFIG.bookImage,
                        book_anchor: CONFIG.bookAnchor
                    });
                } catch (error) {
                    console.error('ä¿å­˜æ’­æ”¾å†å²å¤±è´¥:', error);
                }
            }
            
            // é¢„ç¼“å­˜ä¸‹ä¸€ç« 
            async function preloadNextChapter() {
                if (!state.currentContext || !state.currentContext.next_chapter) {
                        return;
                    }
                    
                const nextChapterId = state.currentContext.next_chapter.chapter_id;
                // å¦‚æœå·²ç¼“å­˜ï¼Œè·³è¿‡
                if (window.audioCachePool.get(nextChapterId)) {
                                return;
                    }
                    
                console.log('é¢„ç¼“å­˜ä¸‹ä¸€ç« :', nextChapterId);
                try {
                    await getAudioUrl(nextChapterId);
                } catch (error) {
                    console.error('é¢„ç¼“å­˜å¤±è´¥:', error);
                }
            }
            
            // ==================== æ’­æ”¾å™¨UIæ›´æ–° ====================
            function updatePlayerUI() {
                if (!globalPlayer || !globalPlayer.audio) {
                    console.log('updatePlayerUI: å…¨å±€æ’­æ”¾å™¨æœªå°±ç»ª');
                        return;
                    }
                    
                const audio = globalPlayer.audio;
                
                // æ’­æ”¾/æš‚åœæŒ‰é’®
                if (elements.playPauseBtn) {
                    if (audio.paused) {
                        elements.playPauseBtn.classList.remove('playing');
                            } else {
                        elements.playPauseBtn.classList.add('playing');
                    }
                }
                
                // æ—¶é—´æ˜¾ç¤º
                if (elements.currentTime) {
                    elements.currentTime.textContent = formatTime(audio.currentTime);
                }
                if (elements.duration) {
                    elements.duration.textContent = formatTime(audio.duration);
                }
                
                // è¿›åº¦æ¡
                if (elements.progressFilled && audio.duration && !isNaN(audio.duration)) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    elements.progressFilled.style.width = Math.max(0, Math.min(100, percent)) + '%';
                }
                
                // éŸ³é‡å›¾æ ‡
                if (elements.muteBtn) {
                    const volumeIcon = elements.muteBtn.querySelector('.volume-icon');
                    const mutedIcon = elements.muteBtn.querySelector('.muted-icon');
                    if (volumeIcon && mutedIcon) {
                        if (audio.muted || audio.volume === 0) {
                            volumeIcon.style.display = 'none';
                            mutedIcon.style.display = 'inline';
                        } else {
                            volumeIcon.style.display = 'inline';
                            mutedIcon.style.display = 'none';
                        }
                    }
                }
            }
            
            // ==================== ç« èŠ‚åˆ‡æ¢ ====================
            async function switchChapter(chapterId, chapterTitle, chapterDuration) {
                if (state.isSwitching) {
                    console.log('æ­£åœ¨åˆ‡æ¢ç« èŠ‚ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
                    return;
                }
                
                state.isSwitching = true;
                console.log('åˆ‡æ¢åˆ°ç« èŠ‚:', chapterId, chapterTitle);
                
                try {
                    if (elements.audioError) {
                        elements.audioError.style.display = 'none';
                    }
                    
                    // æ›´æ–°UI
                    if (elements.chapterTitle) {
                        elements.chapterTitle.textContent = chapterTitle;
                    }
                    if (elements.chapterDuration) {
                        elements.chapterDuration.textContent = 'æ—¶é•¿: ' + chapterDuration;
                    }
                    document.title = chapterTitle + ' - æœ‰å£°ä¹¦æœç´¢';
                    
                    // è·å–éŸ³é¢‘URLï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
                    let audioUrl = null;
                    try {
                        audioUrl = await getAudioUrl(chapterId);
                    } catch (error) {
                        console.error('è·å–éŸ³é¢‘URLå¤±è´¥:', error);
                        // å°è¯•æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°è·å–
                        if (window.audioCachePool) {
                            window.audioCachePool.remove(chapterId);
                        }
                        audioUrl = await getAudioUrl(chapterId);
                    }
                    
                    // ä½¿ç”¨å…¨å±€æ’­æ”¾å™¨æ’­æ”¾
                    if (typeof globalPlayer !== 'undefined' && globalPlayer) {
                        globalPlayer.play(
                            CONFIG.bookId,
                            CONFIG.interface,
                            chapterId,
                            CONFIG.bookTitle,
                            chapterTitle,
                            CONFIG.bookImage,
                            audioUrl
                        );
                        
                        // åº”ç”¨è·³è¿‡ç‰‡å¤´
                        if (state.autoSkipOpening && state.skipOpening > 0 && globalPlayer.audio) {
                            setTimeout(() => {
                                if (globalPlayer.audio) {
                                    globalPlayer.audio.currentTime = state.skipOpening;
                                }
                            }, 500);
                        }
                        
                        // ä¿å­˜å†å²
                        savePlayHistory(chapterId, chapterTitle);
                        
                        // æ›´æ–°ç« èŠ‚ä¸Šä¸‹æ–‡
                        const context = await getChapterContext(chapterId);
                        if (context) {
                            state.currentContext = context;
                            updateChapterButtons(context);
                            // é¢„ç¼“å­˜ä¸‹ä¸€ç« 
                            setTimeout(() => preloadNextChapter(), 1000);
                        }
                        
                        // âœ… å…³é”®ä¿®å¤ï¼šç«‹å³ä¿å­˜æ’­æ”¾çŠ¶æ€åˆ°localStorage
                        // é˜²æ­¢iOSè®¾å¤‡æ¯å±æ¢å¤æ—¶è·³å›ä¹‹å‰çš„ç« èŠ‚
                        globalPlayer.savePlayState();
                    } else {
                        throw new Error('å…¨å±€æ’­æ”¾å™¨æœªåˆå§‹åŒ–');
                    }
                } catch (error) {
                    console.error('åˆ‡æ¢ç« èŠ‚å¤±è´¥:', error);
                    if (elements.audioError) {
                        elements.audioError.style.display = 'block';
                    }
                } finally {
                    state.isSwitching = false;
                }
            }
            
            function updateChapterButtons(context) {
                if (context.prev_chapter && elements.prevBtn) {
                    elements.prevBtn.disabled = false;
                    elements.prevBtn.dataset.chapterId = context.prev_chapter.chapter_id;
                    elements.prevBtn.dataset.chapterTitle = context.prev_chapter.title;
                    elements.prevBtn.dataset.chapterDuration = context.prev_chapter.duration || 'æœªçŸ¥';
                    elements.prevBtn.classList.remove('disabled');
                } else if (elements.prevBtn) {
                    elements.prevBtn.disabled = true;
                    elements.prevBtn.classList.add('disabled');
                }
                
                if (context.next_chapter && elements.nextBtn) {
                    elements.nextBtn.disabled = false;
                    elements.nextBtn.dataset.chapterId = context.next_chapter.chapter_id;
                    elements.nextBtn.dataset.chapterTitle = context.next_chapter.title;
                    elements.nextBtn.dataset.chapterDuration = context.next_chapter.duration || 'æœªçŸ¥';
                    elements.nextBtn.classList.remove('disabled');
                } else if (elements.nextBtn) {
                    elements.nextBtn.disabled = true;
                    elements.nextBtn.classList.add('disabled');
                }
            }
            
            // ==================== å…¨å±€æ’­æ”¾å™¨ç›‘å¬ ====================
            function setupGlobalPlayerListeners() {
                if (typeof globalPlayer === 'undefined' || !globalPlayer.audio) {
                    setTimeout(setupGlobalPlayerListeners, 100);
                            return;
                        }
                        
                const audio = globalPlayer.audio;
                
                // æ’­æ”¾ç»“æŸï¼Œè‡ªåŠ¨ä¸‹ä¸€ç« 
                audio.addEventListener('ended', function onEnded() {
                    if (state.isSwitching) return;
                    
                    if (state.currentContext && state.currentContext.next_chapter) {
                        setTimeout(() => {
                            if (!state.isSwitching) {
                                switchChapter(
                                    state.currentContext.next_chapter.chapter_id,
                                    state.currentContext.next_chapter.title,
                                    state.currentContext.next_chapter.duration || 'æœªçŸ¥'
                                );
                            }
                        }, 500);
                                } else {
                        getChapterContext(CONFIG.chapterId).then(context => {
                            if (context && context.next_chapter && !state.isSwitching) {
                                switchChapter(
                                    context.next_chapter.chapter_id,
                                    context.next_chapter.title,
                                    context.next_chapter.duration || 'æœªçŸ¥'
                                );
                            }
                        });
                    }
                }, { once: false });
                
                // æ—¶é—´æ›´æ–°ï¼šUIæ›´æ–° + è·³è¿‡ç‰‡å°¾æ£€æµ‹
                audio.addEventListener('timeupdate', function onTimeUpdate() {
                    updatePlayerUI();
                    
                    // è·³è¿‡ç‰‡å°¾
                    if (state.autoSkipEnding && state.skipEnding > 0 && audio.duration) {
                        const remaining = audio.duration - audio.currentTime;
                        if (remaining <= state.skipEnding && remaining > 0.5) {
                            audio.currentTime = audio.duration;
                        }
                    }
                });
                
                // æ’­æ”¾çŠ¶æ€å˜åŒ–
                audio.addEventListener('play', () => updatePlayerUI());
                audio.addEventListener('pause', () => updatePlayerUI());
                audio.addEventListener('loadedmetadata', () => updatePlayerUI());
            }
            
            // ==================== åˆå§‹åŒ–æ’­æ”¾ ====================
            async function initPlayback() {
                try {
                    const audioUrl = await getAudioUrl(CONFIG.chapterId);
                    
                    if (typeof globalPlayer !== 'undefined' && globalPlayer) {
                        globalPlayer.play(
                            CONFIG.bookId,
                            CONFIG.interface,
                            CONFIG.chapterId,
                            CONFIG.bookTitle,
                            CONFIG.chapterTitle,
                            CONFIG.bookImage,
                            audioUrl
                        );
                        
                        // åº”ç”¨è·³è¿‡ç‰‡å¤´
                        if (state.autoSkipOpening && state.skipOpening > 0 && globalPlayer.audio) {
                            setTimeout(() => {
                                if (globalPlayer.audio) {
                                    globalPlayer.audio.currentTime = state.skipOpening;
                                }
                            }, 500);
                        }
                        
                        // ä¿å­˜å†å²
                        savePlayHistory(CONFIG.chapterId, CONFIG.chapterTitle);
                        
                        // è·å–ä¸Šä¸‹æ–‡å¹¶é¢„ç¼“å­˜
                        const context = await getChapterContext(CONFIG.chapterId);
                        if (context) {
                            state.currentContext = context;
                            updateChapterButtons(context);
                            setTimeout(() => preloadNextChapter(), 1000);
                        }
                        
                        // è®¾ç½®ç›‘å¬å™¨
                        setupGlobalPlayerListeners();
                    } else {
                        throw new Error('å…¨å±€æ’­æ”¾å™¨æœªåˆå§‹åŒ–');
                    }
                } catch (error) {
                    console.error('åˆå§‹åŒ–æ’­æ”¾å¤±è´¥:', error);
                    if (elements.audioError) {
                        elements.audioError.style.display = 'block';
                    }
                }
            }
            
            // ==================== äº‹ä»¶ç»‘å®š ====================
            function bindEvents() {
                console.log('ç»‘å®šäº‹ä»¶...');
                
                // æ’­æ”¾/æš‚åœæŒ‰é’®å¤„ç†å‡½æ•°
                function handlePlayPause(e) {
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    console.log('æ’­æ”¾/æš‚åœæŒ‰é’®è¢«ç‚¹å‡»');
                    
                    // æ£€æŸ¥globalPlayeræ˜¯å¦å­˜åœ¨
                    if (typeof globalPlayer === 'undefined' || !globalPlayer) {
                        console.warn('å…¨å±€æ’­æ”¾å™¨æœªåˆå§‹åŒ–ï¼Œç­‰å¾…ä¸­...');
                        setTimeout(() => {
                            if (typeof globalPlayer !== 'undefined' && globalPlayer && globalPlayer.audio) {
                                if (globalPlayer.audio.paused) {
                                    globalPlayer.audio.play().catch(err => {
                                        console.error('æ’­æ”¾å¤±è´¥:', err);
                                        // å°è¯•é‡æ–°è·å–éŸ³é¢‘URLå¹¶æ’­æ”¾
                                        if (CONFIG.chapterId) {
                                            getAudioUrl(CONFIG.chapterId).then(audioUrl => {
                                                globalPlayer.play(
                                                    CONFIG.bookId,
                                                    CONFIG.interface,
                                                    CONFIG.chapterId,
                                                    CONFIG.bookTitle,
                                                    CONFIG.chapterTitle,
                                                    CONFIG.bookImage,
                                                    audioUrl
                                                );
                                            }).catch(error => {
                                                console.error('é‡æ–°è·å–éŸ³é¢‘URLå¤±è´¥:', error);
                                            });
                                        }
                                    });
                                } else {
                                    globalPlayer.audio.pause();
                                }
                            }
                        }, 100);
                        return;
                    }
                    
                    if (!globalPlayer.audio) {
                        console.warn('å…¨å±€æ’­æ”¾å™¨audioæœªå°±ç»ªï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...');
                        // å°è¯•é‡æ–°åˆå§‹åŒ–
                        if (typeof globalPlayer.init === 'function') {
                            globalPlayer.init();
                        }
                        setTimeout(() => {
                            if (globalPlayer.audio) {
                                if (globalPlayer.audio.paused) {
                                    globalPlayer.audio.play().catch(err => {
                                        console.error('æ’­æ”¾å¤±è´¥:', err);
                                        // å°è¯•é‡æ–°è·å–éŸ³é¢‘URLå¹¶æ’­æ”¾
                                        if (CONFIG.chapterId) {
                                            getAudioUrl(CONFIG.chapterId).then(audioUrl => {
                                                globalPlayer.play(
                                                    CONFIG.bookId,
                                                    CONFIG.interface,
                                                    CONFIG.chapterId,
                                                    CONFIG.bookTitle,
                                                    CONFIG.chapterTitle,
                                                    CONFIG.bookImage,
                                                    audioUrl
                                                );
                                            }).catch(error => {
                                                console.error('é‡æ–°è·å–éŸ³é¢‘URLå¤±è´¥:', error);
                                            });
                                        }
                                    });
                                } else {
                                    globalPlayer.audio.pause();
                                }
                            } else {
                                console.error('æ’­æ”¾å™¨audioä»ç„¶æœªå°±ç»ª');
                                // å¦‚æœaudioä»ç„¶æœªå°±ç»ªï¼Œå°è¯•é‡æ–°è·å–éŸ³é¢‘URLå¹¶æ’­æ”¾
                                if (CONFIG.chapterId) {
                                    getAudioUrl(CONFIG.chapterId).then(audioUrl => {
                                        globalPlayer.play(
                                            CONFIG.bookId,
                                            CONFIG.interface,
                                            CONFIG.chapterId,
                                            CONFIG.bookTitle,
                                            CONFIG.chapterTitle,
                                            CONFIG.bookImage,
                                            audioUrl
                                        );
                                    }).catch(error => {
                                        console.error('é‡æ–°è·å–éŸ³é¢‘URLå¤±è´¥:', error);
                                    });
                                }
                            }
                        }, 200);
                        return;
                    }
                                    
                    // æ‰§è¡Œæ’­æ”¾/æš‚åœæ“ä½œ
                    if (globalPlayer.audio.paused) {
                        console.log('å¼€å§‹æ’­æ”¾');
                        const playPromise = globalPlayer.audio.play();
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    console.log('æ’­æ”¾æˆåŠŸ');
                                    updatePlayerUI();
                                })
                                .catch(err => {
                                    console.error('æ’­æ”¾å¤±è´¥:', err);
                                    // å¦‚æœæ˜¯ç”¨æˆ·äº¤äº’é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡æ–°è·å–éŸ³é¢‘URLå¹¶æ’­æ”¾
                                    if (err.name === 'NotAllowedError' || err.name === 'NetworkError') {
                                        console.log('æ’­æ”¾å¤±è´¥ï¼Œå°è¯•é‡æ–°è·å–éŸ³é¢‘URLå¹¶æ’­æ”¾');
                                        if (CONFIG.chapterId) {
                                            getAudioUrl(CONFIG.chapterId).then(audioUrl => {
                                                globalPlayer.play(
                                                    CONFIG.bookId,
                                                    CONFIG.interface,
                                                    CONFIG.chapterId,
                                                    CONFIG.bookTitle,
                                                    CONFIG.chapterTitle,
                                                    CONFIG.bookImage,
                                                    audioUrl
                                                );
                                            }).catch(error => {
                                                console.error('é‡æ–°è·å–éŸ³é¢‘URLå¤±è´¥:', error);
                                            });
                                        }
                                    }
                                });
                        }
                    } else {
                        console.log('æš‚åœæ’­æ”¾');
                        globalPlayer.audio.pause();
                        updatePlayerUI();
                    }
                }
                
                // âœ… ä¿®å¤ï¼šä½¿ç”¨removeEventListenerè€Œä¸æ˜¯å…‹éš†æŒ‰é’®ï¼Œé¿å…iOSç‚¹å‡»å¤±æ•ˆ
                // ç»‘å®šæ’­æ”¾/æš‚åœæŒ‰é’®äº‹ä»¶ï¼ˆåŒæ—¶æ”¯æŒç‚¹å‡»å’Œè§¦æ‘¸ï¼‰
                if (elements.playPauseBtn) {
                    console.log('ç»‘å®šæ’­æ”¾/æš‚åœæŒ‰é’®');
                    
                    // âœ… å…ˆç§»é™¤æ—§ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    // æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»ä½¿ç”¨å‘½åå‡½æ•°ï¼Œä¸èƒ½æ˜¯åŒ¿åå‡½æ•°
                    elements.playPauseBtn.removeEventListener('click', handlePlayPause);
                    elements.playPauseBtn.removeEventListener('touchend', handlePlayPauseTouchEnd);
                    
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    elements.playPauseBtn.addEventListener('click', handlePlayPause);
                    
                    // ç»‘å®šè§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    let touchStartTime = 0;
                    function handlePlayPauseTouchStart(e) {
                        touchStartTime = Date.now();
                        // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé¿å…è§¦å‘clickäº‹ä»¶
                        e.preventDefault();
                    }
                    
                    function handlePlayPauseTouchEnd(e) {
                        const touchDuration = Date.now() - touchStartTime;
                        // å¦‚æœè§¦æ‘¸æ—¶é—´å¾ˆçŸ­ï¼ˆ<300msï¼‰ï¼Œè®¤ä¸ºæ˜¯ç‚¹å‡»
                        if (touchDuration < 300) {
                            e.preventDefault();
                            handlePlayPause(e);
                        }
                    }
                    
                    elements.playPauseBtn.addEventListener('touchstart', handlePlayPauseTouchStart, { passive: false });
                    elements.playPauseBtn.addEventListener('touchend', handlePlayPauseTouchEnd, { passive: false });
                } else {
                    console.warn('æ’­æ”¾/æš‚åœæŒ‰é’®æœªæ‰¾åˆ°');
                }
                
                // è¿›åº¦æ¡ç‚¹å‡»/è§¦æ‘¸å¤„ç†å‡½æ•°
                function handleProgressBar(e) {
                    // åªæœ‰åœ¨äº‹ä»¶å¯å–æ¶ˆæ—¶æ‰è°ƒç”¨preventDefault()ï¼Œé¿å…æ»šåŠ¨æ—¶çš„å¹²é¢„è­¦å‘Š
                    if (e.cancelable) {
                        e.preventDefault();
                    }
                    e.stopPropagation();
                    if (typeof globalPlayer === 'undefined' || !globalPlayer || !globalPlayer.audio || !globalPlayer.audio.duration) {
                        console.warn('æ— æ³•è®¾ç½®è¿›åº¦ï¼šæ’­æ”¾å™¨æœªå°±ç»ª');
                        return;
                    }
                    const rect = this.getBoundingClientRect();
                    // æ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸äº‹ä»¶
                    const clientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0] ? e.touches[0].clientX : (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : 0));
                    const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                    globalPlayer.audio.currentTime = percent * globalPlayer.audio.duration;
                    console.log('è®¾ç½®æ’­æ”¾ä½ç½®:', percent * 100 + '%');
                }
                
                // âœ… ä¿®å¤ï¼šä½¿ç”¨removeEventListenerè€Œä¸æ˜¯å…‹éš†DOM
                // ç»‘å®šè¿›åº¦æ¡äº‹ä»¶ï¼ˆåŒæ—¶æ”¯æŒç‚¹å‡»å’Œè§¦æ‘¸ï¼‰
                if (elements.progressBar) {
                    console.log('ç»‘å®šè¿›åº¦æ¡');
                    
                    // âœ… å…ˆç§»é™¤æ—§ç›‘å¬å™¨
                    elements.progressBar.removeEventListener('click', handleProgressBar);
                    elements.progressBar.removeEventListener('touchstart', handleProgressBar);
                    elements.progressBar.removeEventListener('touchmove', handleProgressBar);
                    
                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    elements.progressBar.addEventListener('click', handleProgressBar);
                    
                    // ç»‘å®šè§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    elements.progressBar.addEventListener('touchstart', handleProgressBar, { passive: false });
                    elements.progressBar.addEventListener('touchmove', handleProgressBar, { passive: false });
                } else {
                    console.warn('è¿›åº¦æ¡æœªæ‰¾åˆ°');
                }
                
                // éŸ³é‡æ§åˆ¶
                if (elements.volumeSlider) {
                    elements.volumeSlider.addEventListener('input', function() {
                        if (typeof globalPlayer !== 'undefined' && globalPlayer && globalPlayer.audio) {
                            globalPlayer.audio.volume = this.value;
                        }
                    });
                }
                
                if (elements.muteBtn) {
                    elements.muteBtn.addEventListener('click', function() {
                        if (typeof globalPlayer !== 'undefined' && globalPlayer && globalPlayer.audio) {
                            globalPlayer.audio.muted = !globalPlayer.audio.muted;
                        }
                    });
                }
                
                // ç« èŠ‚åˆ‡æ¢
                if (elements.prevBtn) {
                    elements.prevBtn.addEventListener('click', function() {
                        if (this.disabled || state.isSwitching) return;
                    const chapterId = this.dataset.chapterId;
                    const chapterTitle = this.dataset.chapterTitle;
                    const chapterDuration = this.dataset.chapterDuration;
                    if (chapterId) {
                        switchChapter(chapterId, chapterTitle, chapterDuration);
                    }
                });
            }
            
                if (elements.nextBtn) {
                    elements.nextBtn.addEventListener('click', function() {
                        if (this.disabled || state.isSwitching) return;
                    const chapterId = this.dataset.chapterId;
                    const chapterTitle = this.dataset.chapterTitle;
                    const chapterDuration = this.dataset.chapterDuration;
                    if (chapterId) {
                        switchChapter(chapterId, chapterTitle, chapterDuration);
                    }
                });
            }
            
                // èœå•
                if (elements.menuBtn) {
                    elements.menuBtn.addEventListener('click', function() {
                        if (elements.menuList) {
                            elements.menuList.classList.toggle('hidden');
                        }
                    });
                }
                
                if (elements.menuList) {
                    elements.menuList.addEventListener('click', function(e) {
                        const item = e.target.closest('.menu-item');
                        if (item && item.dataset.menu === 'skip') {
                            if (elements.menuList) elements.menuList.classList.add('hidden');
                            if (elements.skipPanel) elements.skipPanel.classList.remove('hidden');
                        }
                    });
                }
                
                if (elements.skipPanel) {
                    const backBtn = elements.skipPanel.querySelector('.menu-back-btn');
                    if (backBtn) {
                        backBtn.addEventListener('click', function() {
                            if (elements.skipPanel) elements.skipPanel.classList.add('hidden');
                            if (elements.menuList) elements.menuList.classList.remove('hidden');
                        });
                    }
                }
                
                // è·³è¿‡è®¾ç½®
                if (elements.skipOpeningInput) {
                    elements.skipOpeningInput.value = state.skipOpening;
                    elements.skipOpeningInput.addEventListener('change', function() {
                        state.skipOpening = parseInt(this.value) || 0;
                        localStorage.setItem('skipOpening', state.skipOpening);
                    });
                }
                
                if (elements.skipEndingInput) {
                    elements.skipEndingInput.value = state.skipEnding;
                    elements.skipEndingInput.addEventListener('change', function() {
                        state.skipEnding = parseInt(this.value) || 0;
                        localStorage.setItem('skipEnding', state.skipEnding);
                    });
                }
                
                if (elements.autoSkipOpening) {
                    elements.autoSkipOpening.checked = state.autoSkipOpening;
                    elements.autoSkipOpening.addEventListener('change', function() {
                        state.autoSkipOpening = this.checked;
                        localStorage.setItem('autoSkipOpening', state.autoSkipOpening);
                    });
                }
                
                if (elements.autoSkipEnding) {
                    elements.autoSkipEnding.checked = state.autoSkipEnding;
                    elements.autoSkipEnding.addEventListener('change', function() {
                        state.autoSkipEnding = this.checked;
                        localStorage.setItem('autoSkipEnding', state.autoSkipEnding);
                    });
                }
                
                // è¿”å›æœç´¢ç»“æœé¡µ
                const backToResults = document.getElementById('back-to-results');
                if (backToResults) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const keyword = urlParams.get('keyword') || localStorage.getItem('lastSearchKeyword');
                    if (keyword) {
                        backToResults.href = `/results?keyword=${encodeURIComponent(keyword)}`;
                    } else {
                        backToResults.href = '/';
                    }
                }
            }
            
            // ==================== é¡µé¢åˆå§‹åŒ– ====================
            function init() {
                console.log('æ’­æ”¾é¡µåˆå§‹åŒ–å¼€å§‹');
                console.log('DOMå…ƒç´ æ£€æŸ¥:', {
                    playPauseBtn: !!elements.playPauseBtn,
                    progressBar: !!elements.progressBar,
                    prevBtn: !!elements.prevBtn,
                    nextBtn: !!elements.nextBtn
                });
                
                // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†ç»‘å®šäº‹ä»¶
                function doInit() {
                    // é‡æ–°è·å–DOMå…ƒç´ ï¼ˆé˜²æ­¢ä»å†å²è®°å½•è·³è½¬æ—¶å…ƒç´ æœªæ›´æ–°ï¼‰
                    elements.playPauseBtn = document.getElementById('custom-play-pause-btn');
                    elements.progressBar = document.getElementById('progress-bar');
                    elements.progressFilled = document.getElementById('progress-filled');
                    elements.prevBtn = document.getElementById('prev-chapter-btn');
                    elements.nextBtn = document.getElementById('next-chapter-btn');
                    
                    // ç»‘å®šäº‹ä»¶ï¼ˆäº‹ä»¶å¤„ç†å‡½æ•°å†…éƒ¨ä¼šæ£€æŸ¥globalPlayerï¼‰
                    bindEvents();
                    
                    // ç­‰å¾…globalPlayeråˆå§‹åŒ–åå†æ’­æ”¾
                    let retryCount = 0;
                    const maxRetries = 50; // æœ€å¤šç­‰å¾…5ç§’
                    
                    function waitForGlobalPlayer() {
                        if (typeof globalPlayer !== 'undefined' && globalPlayer) {
                            console.log('å…¨å±€æ’­æ”¾å™¨å·²å°±ç»ª');
                            // å¦‚æœaudioè¿˜æ²¡åˆ›å»ºï¼Œç­‰å¾…ä¸€ä¸‹
                            if (!globalPlayer.audio) {
                                retryCount++;
                                if (retryCount < maxRetries) {
                                    setTimeout(waitForGlobalPlayer, 100);
                                } else {
                                    console.error('ç­‰å¾…globalPlayer.audioè¶…æ—¶');
                                    // å°è¯•é‡æ–°åˆå§‹åŒ–
                                    if (typeof globalPlayer.init === 'function') {
                                        globalPlayer.init();
                                    }
                                }
                                return;
                            }
                            console.log('å¼€å§‹åˆå§‹åŒ–æ’­æ”¾');
                            initPlayback();
                        } else {
                            retryCount++;
                            if (retryCount < maxRetries) {
                                console.log('ç­‰å¾…å…¨å±€æ’­æ”¾å™¨åˆå§‹åŒ–...', retryCount);
                                setTimeout(waitForGlobalPlayer, 100);
                            } else {
                                console.error('ç­‰å¾…globalPlayeråˆå§‹åŒ–è¶…æ—¶');
                                if (elements.audioError) {
                                    elements.audioError.style.display = 'block';
                                    const errorMsg = elements.audioError.querySelector('p');
                                    if (errorMsg) {
                                        errorMsg.textContent = 'æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                                    }
                                }
                            }
                        }
                    }
                    
                    waitForGlobalPlayer();
                }
                
                // ç¡®ä¿DOMå®Œå…¨åŠ è½½
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', doInit);
                } else {
                    // DOMå·²åŠ è½½ï¼Œä½†å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½å·²æ‰§è¡Œ
                    setTimeout(doInit, 50);
                }
            }
            
            init();
        })();
    </script>
</body>
</html>
