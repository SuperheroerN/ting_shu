<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="æœ‰å£°ä¹¦æœç´¢å’Œæ’­æ”¾å¹³å°">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æœ‰å£°ä¹¦">
    <title>æœ‰å£°ä¹¦æœç´¢</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/home.css">
    <link rel="stylesheet" href="/static/css/navbar.css">
    <link rel="stylesheet" href="/static/css/announcement.css">
    <link rel="stylesheet" href="/static/css/global-player.css">
</head>
<body>
    <div class="container homepage">
        <!-- æœç´¢æ æ”¾åœ¨é¡¶éƒ¨ -->
        <header class="search-header">
            <form id="search-form" action="/results" method="GET">
                <input type="text" id="keyword" name="keyword" placeholder="è¯·è¾“å…¥ä¹¦åæˆ–ä½œè€…" required>
                <button type="submit">æœç´¢</button>
            </form>
        </header>
        
        <!-- ä¹¦æ¶åŒºåŸŸ -->
        <div class="bookshelf-section">
            <h2 class="bookshelf-title">æˆ‘çš„ä¹¦æ¶</h2>
            <div id="bookshelf-container" class="bookshelf-books">
                <!-- ä¹¦æ¶å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">æœç´¢ä¸­...</div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/auth-guard.js"></script>
    <script src="/static/js/announcement.js"></script>
    <script src="/static/js/global-player.js"></script>
    <script src="/static/js/pwa-install.js"></script>
    <script src="/static/js/pwa-debug.js"></script>
    <script>
        // ä¹¦æ¶åŠŸèƒ½ï¼ˆä½¿ç”¨APIï¼‰
        async function renderBookshelf() {
            const container = document.getElementById('bookshelf-container');
            
            if (!container) {
                console.error('æ‰¾ä¸åˆ°ä¹¦æ¶å®¹å™¨');
                return;
            }
            
            try {
                const response = await BookshelfAPI.get();
                const bookshelf = response.books || [];
                
                if (bookshelf.length === 0) {
                    container.innerHTML = '<div class="no-bookshelf">ä¹¦æ¶ä¸ºç©ºï¼Œå¿«å»æ·»åŠ å–œæ¬¢çš„ä¹¦ç±å§ï¼</div>';
                    container.classList.add('empty');
                    return;
                } else {
                    container.classList.remove('empty');
                }
                
                container.innerHTML = bookshelf.map(book => {
                    return `
                    <div class="bookshelf-book-card" 
                         data-book-id="${book.book_id}" 
                         data-interface="${book.interface}"
                         onclick="location.href='/detail/${book.book_id}/${book.interface}'">
                        <div class="bookshelf-book-image">
                            <img src="${book.book_image || 'https://via.placeholder.com/150x200?text=å°é¢ç¼ºå¤±'}" 
                                 alt="${book.book_title || 'æœªçŸ¥ä¹¦ç±'}" 
                                 onerror="this.src='https://via.placeholder.com/150x200?text=å°é¢ç¼ºå¤±'">
                        </div>
                        <div class="bookshelf-book-name">${book.book_title || 'æœªçŸ¥ä¹¦ç±'}</div>
                    </div>
                `;
                }).join('');
                
                // ç»‘å®šé•¿æŒ‰åˆ é™¤äº‹ä»¶
                bindLongPressDelete();
            } catch (error) {
                console.error('è·å–ä¹¦æ¶å¤±è´¥:', error);
                container.innerHTML = '<div class="no-bookshelf">è·å–ä¹¦æ¶å¤±è´¥ï¼Œè¯·å…ˆç™»å½•</div>';
            }
        }
        
        // é•¿æŒ‰åˆ é™¤åŠŸèƒ½
        let longPressTimer = null;
        let isLongPress = false;
        
        function bindLongPressDelete() {
            const cards = document.querySelectorAll('.bookshelf-book-card');
            
            cards.forEach(card => {
                // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                card.addEventListener('mousedown', function(e) {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        showDeleteDialog(this);
                    }, 500); // 500msé•¿æŒ‰
                });
                
                card.addEventListener('mouseup', function() {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                card.addEventListener('mouseleave', function() {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                card.addEventListener('touchstart', function(e) {
                    isLongPress = false;
                    const cardElement = this;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                        showDeleteDialog(cardElement);
                    }, 500); // 500msé•¿æŒ‰
                }, { passive: false });
                
                card.addEventListener('touchend', function() {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                card.addEventListener('touchmove', function() {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                // é˜»æ­¢é•¿æŒ‰æ—¶è§¦å‘ç‚¹å‡»äº‹ä»¶
                card.addEventListener('click', function(e) {
                    if (isLongPress) {
                        e.preventDefault();
                        e.stopPropagation();
                        isLongPress = false;
                    }
                });
            });
        }
        
        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
        function showDeleteDialog(card) {
            const bookId = card.dataset.bookId;
            const interface = card.dataset.interface;
            const bookName = card.querySelector('.bookshelf-book-name').textContent;
            
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'delete-overlay';
            overlay.innerHTML = `
                <div class="delete-dialog">
                    <div class="delete-dialog-title">åˆ é™¤ç¡®è®¤</div>
                    <div class="delete-dialog-content">
                        ç¡®å®šè¦åˆ é™¤ã€Š${bookName}ã€‹å—ï¼Ÿ
                    </div>
                    <div class="delete-dialog-buttons">
                        <button class="delete-btn-cancel">å–æ¶ˆ</button>
                        <button class="delete-btn-confirm">åˆ é™¤</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            overlay.querySelector('.delete-btn-cancel').addEventListener('click', function() {
                document.body.removeChild(overlay);
            });
            
            overlay.querySelector('.delete-btn-confirm').addEventListener('click', async function() {
                try {
                    // åˆ é™¤ä¹¦ç±
                    await BookshelfAPI.remove(bookId, interface);
                    
                    // ç§»é™¤é®ç½©å±‚
                    document.body.removeChild(overlay);
                    
                    // åˆ·æ–°ä¹¦æ¶
                    await renderBookshelf();
                    
                    // è§¦å‘æ›´æ–°äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('bookshelfUpdated'));
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showToast('å·²åˆ é™¤');
                } catch (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                }
            });
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }
        
        // åˆå§‹åŒ–ä¹¦æ¶
        document.addEventListener('DOMContentLoaded', function() {
            renderBookshelf();
            
            // ç›‘å¬ä¹¦æ¶æ›´æ–°äº‹ä»¶
            window.addEventListener('bookshelfUpdated', function() {
                renderBookshelf();
            });
        });
        
        // æœç´¢åŠŸèƒ½
        document.getElementById('search-form').addEventListener('submit', function(e) {
            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) {
                e.preventDefault();
                return;
            }
            
            // ä¿å­˜æœç´¢å…³é”®è¯åˆ°localStorageï¼ˆç”¨äºé¡µé¢è·³è½¬ï¼‰
            localStorage.setItem('lastSearchKeyword', keyword);
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
        });
        
    </script>
    
    <!-- å…¨å±€æµ®åŠ¨æ’­æ”¾å™¨ï¼ˆç”± global-player.js è‡ªåŠ¨åˆ›å»ºï¼‰ -->
    
    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="bottom-navbar">
        <div class="bottom-navbar-container">
            <a href="/" class="nav-item active">
                <span class="nav-item-icon">ğŸ </span>
                <span class="nav-item-text">é¦–é¡µ</span>
            </a>
            <a href="/history" class="nav-item">
                <span class="nav-item-icon">ğŸ“œ</span>
                <span class="nav-item-text">å†å²</span>
            </a>
            <a href="/profile" class="nav-item">
                <span class="nav-item-icon">ğŸ‘¤</span>
                <span class="nav-item-text">æˆ‘çš„</span>
            </a>
        </div>
    </nav>
</body>
</html>